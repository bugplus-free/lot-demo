<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MQTT å‘é€/æ¥æ”¶ æ¶ˆæ¯</title>
    <script src="https://unpkg.com/mqtt/dist/mqtt.min.js"></script>
</head>
<body>
    <h2>MQTT å‘é€æ¶ˆæ¯åˆ° `topic/beginfirefox` å¹¶ç›‘å¬ `topic/beginfirefox/response`</h2>

    <label for="message">æ¶ˆæ¯å†…å®¹ï¼š</label>
    <input type="text" id="message" value="Open Firefox"><br><br>

    <button onclick="sendMessage()">å‘é€ MQTT æ¶ˆæ¯</button>

    <h3>çŠ¶æ€:</h3>
    <p id="status">æœªè¿æ¥</p>

    <h3>å‘é€æ—¥å¿—:</h3>
    <pre id="log"></pre>

    <h3>æ¥æ”¶çš„å“åº”æ¶ˆæ¯:</h3>
    <pre id="response"></pre>

    <script>
        // MQTT æœåŠ¡å™¨ WebSocket åœ°å€ï¼ˆæ³¨æ„è·¯å¾„åè¦åŠ  "/mqtt"ï¼‰
        const broker = "ws://192.168.57.231:8083/mqtt";  // ä½ çš„ MQTT æœåŠ¡å™¨åœ°å€ï¼ˆWebSocketï¼‰
        const topicSend = "topic/beginfirefox"; // å‘é€ä¸»é¢˜
        const topicResponse = "topic/beginfirefox/response"; // è®¢é˜…çš„å“åº”ä¸»é¢˜
        const clientId = "mqtt_client_" + Math.random().toString(16).substr(2, 8); // ç”Ÿæˆå”¯ä¸€ Client ID

        // åˆ›å»º MQTT å®¢æˆ·ç«¯
        const options = {
            clean: true,
            connectTimeout: 4000,
            clientId: clientId,
        };

        const client = mqtt.connect(broker, options);

        // æ›´æ–°çŠ¶æ€
        function updateStatus(statusText) {
            document.getElementById("status").textContent = statusText;
        }

        function logMessage(msg) {
            document.getElementById("log").textContent += msg + "\n";
        }

        function logResponse(msg) {
            document.getElementById("response").textContent += msg + "\n";
        }

        // è¿æ¥æˆåŠŸ
        client.on("connect", () => {
            updateStatus("âœ… å·²è¿æ¥");
            logMessage("å·²æˆåŠŸè¿æ¥åˆ° MQTT æœåŠ¡å™¨");

            // è®¢é˜… `topic/beginfirefox/response` ä»¥æ¥æ”¶è¿”å›æ¶ˆæ¯
            client.subscribe(topicResponse, (err) => {
                if (!err) {
                    logMessage(`ğŸ“¥ å·²è®¢é˜…: ${topicResponse}`);
                } else {
                    logMessage("âŒ è®¢é˜…å¤±è´¥: " + err.message);
                }
            });
        });

        // è¿æ¥å¤±è´¥
        client.on("error", (err) => {
            updateStatus("âŒ è¿æ¥å¤±è´¥");
            logMessage("è¿æ¥å¤±è´¥: " + err.message);
        });

        // å¤„ç†æ¥æ”¶åˆ°çš„æ¶ˆæ¯
        client.on("message", (receivedTopic, message) => {
            if (receivedTopic === topicResponse) {
                logResponse(`ğŸ“© æ”¶åˆ°å“åº”: ${message.toString()}`);
            }
        });

        // å‘é€ MQTT æ¶ˆæ¯
        function sendMessage() {
            const message = document.getElementById("message").value;

            if (client.connected) {
                client.publish(topicSend, message, { qos: 0 }, (err) => {
                    if (!err) {
                        logMessage(`ğŸ“¤ å·²å‘é€: ${message}`);
                        alert("æ¶ˆæ¯å‘é€æˆåŠŸ");
                    } else {
                        logMessage("âŒ å‘é€å¤±è´¥: " + err.message);
                        alert("æ¶ˆæ¯å‘é€å¤±è´¥ï¼Œè¯·æ£€æŸ¥ MQTT æœåŠ¡å™¨");
                    }
                });
            } else {
                alert("MQTT æœªè¿æ¥ï¼Œè¯·ç¨åé‡è¯•");
                logMessage("âš ï¸ å‘é€å¤±è´¥ï¼šæœªè¿æ¥åˆ° MQTT æœåŠ¡å™¨");
            }
        }
    </script>
</body>
</html>
